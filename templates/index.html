<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì—¬ê°€ íë ˆì´ì…˜ (v24 - Render ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* v23ì—ì„œ ìš”ì²­í•œ 'ë¸”ë£¨/ê·¸ë¦°' í…Œë§ˆ CSS */
        body { 
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #F0FDF4, #F0F9FF);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 0.5rem;
        }
        /* í°ìƒ‰ ì¹´ë“œ UI (ëª¨ë°”ì¼/ì›¹ í˜¸í™˜) */
        #app-container { 
            max-width: 900px; 
            margin: 1rem auto; 
            max-height: 95vh;
            overflow-y: auto;
            border-radius: 1.5rem; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            background: white;
            overflow: hidden; /* ë‚´ë¶€ ì»´í¬ë„ŒíŠ¸ê°€ ë‘¥ê·¼ ëª¨ì„œë¦¬ë¥¼ ë”°ë¥´ë„ë¡ */
        }
        /* [ìš”ì²­ 1] ë¼ë²¨(ì œëª©)ì„ êµµê³  ì§„í•œ ì²­ë¡ìƒ‰ìœ¼ë¡œ */
        label[data-testid="block-label"] { 
            display: block; /* Gradio ëª¨ë°© */
            font-weight: 600; 
            color: #0F766E; /* ì§™ì€ ì²­ë¡ìƒ‰ */
            font-size: 1.05rem; /* ì‚´ì§ í¬ê²Œ */
            padding-bottom: 4px;
        }
        /* ê·¸ë£¹(í™”ë©´) ìŠ¤íƒ€ì¼ */
        .page-group { 
            background-color: white; 
            padding: 2rem;
        }
        /* í™”ë©´ ì œëª© ìŠ¤íƒ€ì¼ */
        .page-title { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: #0D9488; /* ì§™ì€ ì²­ë¡ìƒ‰ */
            border-bottom: 2px solid #CCFBF1; /* ì—°í•œ ì²­ë¡ìƒ‰ */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        /* [ìš”ì²­ 1] ì…ë ¥ì°½ í¬ì»¤ìŠ¤(í´ë¦­) ì‹œ */
        input[type="text"], input[type="number"], input[type="tel"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            background-color: #F9FAFB;
        }
        input[type="text"]:focus, 
        input[type="number"]:focus, 
        input[type="tel"]:focus,
        select:focus { 
            border-color: #0D9488 !important; 
            box-shadow: 0 0 0 3px #A7F3D0 !important; /* ë°ì€ ë…¹ìƒ‰ */
            transition: all 0.2s; 
            outline: none;
        }
        input[type="range"] { width: 100%; }
        /* ê²°ê³¼ì°½ ë””ìì¸ */
        #result-card { background-color: #F0FDF4; border-left: 5px solid #10B981; border-radius: 8px; padding: 1.5rem; }
        #result-title { color: #065F46; border-bottom: 2px solid #6EE7B7; }
        #history-accordion { border: 1px solid #D1FAE5; border-radius: 8px; }
        /* [ìš”ì²­ 2] 'ì „í™”ë²ˆí˜¸ ë³€ê²½' ì•„ì½”ë””ì–¸ì„ ë²„íŠ¼ì²˜ëŸ¼ */
        #phone-accordion summary { /* ì•„ì½”ë””ì–¸ í—¤ë” */
            background-color: #F9FAFB;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
            list-style: none; /* í™”ì‚´í‘œ ì œê±° */
        }
        #phone-accordion summary::-webkit-details-marker { display: none; } /* í™”ì‚´í‘œ ì œê±° */
        #phone-accordion summary:hover { background-color: #F3F4F6; }
        #phone-accordion[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        #phone-accordion > div { padding: 1rem; border: 1px solid #D1D5DB; border-top: 0; border-radius: 0 0 8px 8px; }

        /* [ìš”ì²­ 3] 'ê¸°ë°˜ ë§Œì¡±ë„' ë¶€ì—°ì„¤ëª… í…ìŠ¤íŠ¸ */
        .description-text { 
            color: #4B5563; 
            font-style: italic; 
            margin-top: -0.75rem; 
            margin-bottom: 1rem; 
            font-size: 0.9rem;
        }
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .g-button { /* Gradio ë²„íŠ¼ ëª¨ë°© */
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            width: 100%; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        }
        @media (min-width: 640px) { /* PCì—ì„œëŠ” ë²„íŠ¼ ë„ˆë¹„ ìë™ */
             .g-button { width: auto; }
        }
        button.primary { background: #0D9488; color: white; } /* ì²­ë¡ìƒ‰ */
        button.primary:hover { background: #0F766E; }
        button.secondary { 
            background: #F0F9FF; color: #0284C7; 
            border: 1px solid #0284C7;
        }
        button.secondary:hover { background: #E0F2FE; }
        /* [ìš”ì²­ 1] ë¹„í™œì„±í™”ëœ ë²„íŠ¼ */
        button.primary:disabled { background: #9CA3AF; cursor: not-allowed; }
        
        /* ê°œì¸ì •ë³´ë³´í˜¸ ë¬¸êµ¬ (ìš”ì²­ 4) */
        #privacy-text { font-size: 12px; color: #6B7280; text-align: center; margin-top: 1.5rem; }
    </style>
</head>
<body>
    
    <div id="app-container">
        
        <header class="p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-center">
            <h1 class="text-3xl font-bold">AI ì—¬ê°€ ì»¨ì„¤í„´íŠ¸ (v24 - Render)</h1>
            <p class="mt-2 text-blue-100">ë‹¹ì‹ ì˜ ì™„ë²½í•œ ì—¬ê°€ ìƒí™œì„ ì°¾ì•„ë³´ì„¸ìš”</p>
        </header>

        <div id="loading" class="text-center p-8 hidden">
            <svg class="animate-spin h-10 w-10 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600">AIê°€ 504ê°œì˜ ê¶¤ì ì„ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <div id="page-login" class="page-group fade-in">
            <h2 class="page-title">1. ë¡œê·¸ì¸</h2>
            <p class="text-gray-600 mb-6">AIê°€ ê¶¤ì ì„ ì •ë°€í•˜ê²Œ ë¶„ì„í•  ìˆ˜ ìˆë„ë¡ ë³¸ì¸ ì¸ì¦ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label data-testid="block-label" for="i_name"><span>ì´ë¦„</span></label>
                        <input type="text" id="i_name" placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                    <div>
                        <label data-testid="block-label" for="i_dob"><span>ìƒë…„ì›”ì¼ (YYYYMMDD)</span></label>
                        <input type="text" id="i_dob" placeholder="ì˜ˆ: 19900101" maxlength="8">
                    </div>
                </div>
                <div>
                    <label data-testid="block-label" for="i_phone"><span>íœ´ëŒ€ì „í™” (01X-XXXX-XXXX)</span></label>
                    <input type="tel" id="i_phone" placeholder="ì˜ˆ: 010-1234-5678">
                </div>
                
                <details id="phone-accordion">
                    <summary>ğŸ“ íœ´ëŒ€ì „í™” ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆë‚˜ìš”? (í´ë¦­)</summary>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="i_phone_changed" class="h-4 w-4 text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">ë„¤, ì´ì „ ë²ˆí˜¸ë¡œ ê¶¤ì ì„ ì´ì–´ê°‘ë‹ˆë‹¤.</span>
                        </label>
                        <div id="old-phone-container" class="hidden mt-2">
                            <label data-testid="block-label" for="i_old_phone"><span>ì´ì „ íœ´ëŒ€ì „í™” ë²ˆí˜¸</span></label>
                            <input type="tel" id="i_old_phone" placeholder="ì˜ˆ: 010-8765-4321">
                        </div>
                    </div>
                </details>
                
                <button id="login-btn" class="g-button primary w-full" disabled>ë¡œê·¸ì¸ / ë‚´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <p id="o_id_status" class="text-center text-gray-500 text-sm mt-2">*(ì´ë¦„, ìƒë…„ì›”ì¼(8ìë¦¬), íœ´ëŒ€ì „í™”(11ìë¦¬ ì´ìƒ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”)*</p>
                <p id="privacy-text">ì…ë ¥í•˜ì‹  ê°œì¸ì •ë³´ëŠ” AI íë ˆì´ì…˜ ë¶„ì„ ë° ëª¨ë¸ ì„±ì¥ì„ ìœ„í•´ì„œë§Œ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ë©°, ì™¸ë¶€ì— ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="page-fixed-info" class="page-group hidden fade-in">
            <h2 class="page-title">2. ë‚´ ê³ ì • ì •ë³´ (User Profile)</h2>
            <p class="text-gray-600 mb-6">AIê°€ 'ìµœì  ê¶¤ì 'ì„ íƒìƒ‰í•˜ëŠ” ê¸°ì¤€ì´ ë˜ëŠ” **ê³ ì • ë³€ìˆ˜**ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label data-testid="block-label" for="i_age"><span>1. ë‚˜ì´ (<span id="age-display">39 ì„¸</span>)</span></label>
                        <input type="range" id="i_age" min="20" max="69" value="39">
                    </div>
                    <div>
                        <label data-testid="block-label" for="i_gender"><span>3. ì„±ë³„</span></label>
                        <select id="i_gender">
                            <option value="1" selected>ë‚¨ì„±</option>
                            <option value="2">ì—¬ì„±</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label data-testid="block-label" for="i_job"><span>2. ì§ì—…</span></label>
                        <select id="i_job">
                            <option value="1">ìì˜ì—…</option><option value="2">íŒë§¤/ì„œë¹„ìŠ¤ì§</option><option value="3">ê¸°ëŠ¥/ìˆ™ë ¨ê³µ</option>
                            <option value="4">ì¼ë°˜ì‘ì—…ì§</option><option value="5" selected>ì‚¬ë¬´ì§</option><option value="6">ê¸°ìˆ ì§</option>
                            <option value="7">ê²½ì˜/ê´€ë¦¬ì§</option><option value="8">ì „ë¬¸ì§</option><option value="9">ììœ ì§</option>
                            <option value="10">ì „ì—…ì£¼ë¶€</option><option value="11">ëŒ€í•™(ì›)ìƒ</option><option value="12">ë¬´ì§</option>
                            <option value="nan">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div>
                        <label data-testid="block-label" for="i_marriage"><span>4. ê²°í˜¼ìƒíƒœ</span></label>
                        <select id="i_marriage">
                            <option value="1">ë¯¸í˜¼</option>
                            <option value="2" selected>ê¸°í˜¼</option>
                            <option value="3">ê¸°íƒ€(ì´í˜¼/ì‚¬ë³„)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label data-testid="block-label" for="i_income"><span>5. ê°€êµ¬ ì›”ì†Œë“ (<span id="income-display">400 ë§Œì›</span>)</span></label>
                    <input type="range" id="i_income" min="0" max="2000" step="50" value="400">
                </div>
                <hr>
                <h3 class="text-lg font-semibold text-gray-800">ê¸°ë°˜ ë§Œì¡±ë„ (í˜„ì¬ ìƒíƒœ)</h3>
                <p class="description-text">í˜„ì¬ ì¦ê¸°ê³  ìˆëŠ” ì—¬ê°€ì— ê´€í•´ ë‹µí•´ì£¼ì„¸ìš”.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label data-testid="block-label" for="i_infra_sat"><span>6. ì¸í”„ë¼ ë§Œì¡±ë„ (<span id="infra-display">4 ì </span>)</span></label>
                        <input type="range" id="i_infra_sat" min="1" max="5" step="1" value="4">
                    </div>
                    <div>
                        <label data-testid="block-label" for="i_time_sat"><span>7. ì‹œê°„ ë§Œì¡±ë„ (<span id="time-display">4 ì </span>)</span></label>
                        <input type="range" id="i_time_sat" min="1" max="5" step="1" value="4">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between mt-4 space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="prev-btn-2" class="g-button secondary">ì´ì „ (ë¡œê·¸ì•„ì›ƒ)</button>
                    <button id="next-btn-2" class="g-button primary">ë‹¤ìŒ (ì—¬ê°€ í™œë™ ì…ë ¥)</button>
                </div>
            </div>
        </div>

        <div id="page-simulator" class="page-group hidden fade-in">
            <h2 class="page-title">3. í˜„ì¬ ì—¬ê°€ í™œë™</h2>
            <p class="text-gray-600 mb-6">í˜„ì¬ ë‹¹ì‹ ì˜ ì—¬ê°€ í™œë™ì„ ì„ íƒí•˜ë©´, AIê°€ ì´ ì¡°í•©ì˜ 5ì  ë§Œì¡± í™•ë¥ ê³¼ **ë¯¸ë˜ì˜ 'ìµœì  ê¶¤ì '**ì„ íƒìƒ‰í•©ë‹ˆë‹¤.</p>
            <div class="space-y-6">
                <div>
                    <label data-testid="block-label" for="i_purpose"><span>8. í˜„ì¬ ì—¬ê°€ ëª©ì </span></label>
                    <select id="i_purpose">
                        <option value="1">ê°€ì¡±/ì§€ì¸</option><option value="2">ê±´ê°•</option><option value="3">ë‚¨ëŠ” ì‹œê°„</option>
                        <option value="4">ëŒ€ì¸ê´€ê³„</option><option value="5">íœ´ì‹</option><option value="6" selected>ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ</option>
                        <option value="7">ìê¸°ê³„ë°œ</option><option value="8">ìê¸°ë§Œì¡±/ì¦ê±°ì›€</option><option value="9">ê¸°íƒ€</option>
                    </select>
                </div>
                <div>
                    <label data-testid="block-label" for="i_activity"><span>9. í˜„ì¬ ì£¼ìš” í™œë™</span></label>
                    <select id="i_activity">
                        <option value="1">ë¬¸í™”ì˜ˆìˆ ê´€ëŒ</option><option value="2">ë¬¸í™”ì˜ˆìˆ ì§ì ‘</option><option value="3">ìŠ¤í¬ì¸ ê´€ëŒ</option>
                        <option value="4">ìŠ¤í¬ì¸ ì§ì ‘</option><option value="5">ê´€ê´‘/ì—¬í–‰</option><option value="6" selected>ì˜¤ë½/íœ´ì‹</option>
                        <option value="7">ìê¸°ê³„ë°œ</option><option value="8">ì‚¬íšŒêµë¥˜</option><option value="nan">ê¸°íƒ€</option>
                    </select>
                </div>
                <div>
                    <label data-testid="block-label" for="i_partner"><span>10. í˜„ì¬ ë™ë°˜ì</span></label>
                    <select id="i_partner">
                        <option value="1" selected>í˜¼ì</option><option value="2">ê°€ì¡±/ì¹œì²™</option><option value="3">ì¹œêµ¬</option>
                        <option value="4">ì—°ì¸</option><option value="5">ì§ì¥ë™ë£Œ</option><option value="6">ë™í˜¸íšŒ</option>
                        <option value="7">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row justify-between mt-4 space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="prev-btn-3" class="g-button secondary">ì´ì „ (ë‚´ ì •ë³´ ìˆ˜ì •)</button>
                    <button id="submit-btn" class="g-button primary">ìµœì ì˜ ê¶¤ì  íƒìƒ‰í•˜ê¸° (AI ì‹œë®¬ë ˆì´ì…˜)</button>
                </div>
            </div>
        </div>

        <div id="page-results" class="page-group hidden fade-in">
            <h2 class="page-title" id="result-title">4. AI ì¶”ì²œ ê¶¤ì </h2>
            <p id="o_model_version" class="text-sm text-gray-400 -mt-8 mb-6">(AI Model: v1)</p>
            
            <div id="result-card" class="mb-6">
                <label data-testid="block-label" for="o_probability"><span>í˜„ì¬ ì¡°í•©ì˜ 5ì  ë§Œì¡±ë„ í™•ë¥ </span></label>
                <p id="o_probability" class="text-4xl font-bold text-green-700">0.0%</p>
                <label data-testid="block-label" for="o_persona" class="mt-4"><span>AI í˜ë¥´ì†Œë‚˜ ì§„ë‹¨ (í˜„ì¬ ê¸°ì¤€)</span></label>
                <p id="o_persona" class="text-lg font-semibold text-gray-700"></p>
            </div>
            
            <details id="history-accordion" class="mb-6 hidden">
                <summary class="font-semibold text-gray-700">ë‚´ ê³¼ê±° ê¶¤ì  (íˆìŠ¤í† ë¦¬)</summary>
                <div id="o_history_output" class="p-4 text-sm text-gray-600 bg-gray-50 rounded-b-lg"></div>
            </details>
            
            <div>
                <label data-testid="block-label"><span>ğŸ“ˆ 'ë§Œì¡±ë„ 5ì 'ì„ ìœ„í•œ ìµœì ì˜ ê¶¤ì  (AI ì‹œë®¬ë ˆì´ì…˜)</span></label>
                <div id="o_recommendations" class="text-gray-700 space-y-4"></div>
            </div>
            
            <button id="restart-btn-4" class="g-button secondary w-full mt-8">ë‹¤ì‹œ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° (3ë‹¨ê³„ë¡œ)</button>
        </div>
        
    </div>

    <script type="module">
        // --- 1. Firebase ì„¤ì • (v20ì˜ ID/ê¶¤ì  ì €ì¥ ê¸°ëŠ¥) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDF4NmoY2lXK5hUcJ832jtTbK5e3cIty6M",
            authDomain: "curation-5e526.firebaseapp.com",
            projectId: "curation-5e526",
            storageBucket: "curation-5e526.firebasestorage.app",
            messagingSenderId: "1032425542483",
            appId: "1:1032425542483:web:b505dc4a383ad47c3b07a6",
            measurementId: "G-JYFX416017"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. AI ì„œë²„(Render) ì£¼ì†Œ ---
        const AI_SERVER_URL = "/predict"; 

        // --- 3. UI ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const loadingEl = document.getElementById('loading');
        const pageLogin = document.getElementById('page-login');
        const pageFixedInfo = document.getElementById('page-fixed-info');
        const pageSimulator = document.getElementById('page-simulator');
        const pageResults = document.getElementById('page-results');
        
        // ë²„íŠ¼
        const loginBtn = document.getElementById('login-btn');
        const nextBtn2 = document.getElementById('next-btn-2');
        const prevBtn2 = document.getElementById('prev-btn-2');
        const submitBtn = document.getElementById('submit-btn');
        const prevBtn3 = document.getElementById('prev-btn-3');
        const restartBtn4 = document.getElementById('restart-btn-4');
        
        // ë¡œê·¸ì¸ ì…ë ¥ (v20)
        const iName = document.getElementById('i_name');
        const iDob = document.getElementById('i_dob');
        const iPhone = document.getElementById('i_phone');
        const iPhoneChanged = document.getElementById('i_phone_changed');
        const iOldPhone = document.getElementById('i_old_phone');
        const iOldPhoneContainer = document.getElementById('old-phone-container');
        const oIdStatus = document.getElementById('o_id_status');
        
        // ê³ ì • ì •ë³´ ì…ë ¥ (v20)
        const iAge = document.getElementById('i_age');
        const iGender = document.getElementById('i_gender');
        const iJob = document.getElementById('i_job');
        const iMarriage = document.getElementById('i_marriage');
        const iIncome = document.getElementById('i_income');
        const iInfraSat = document.getElementById('i_infra_sat');
        const iTimeSat = document.getElementById('i_time_sat');
        
        // ì‹œë®¬ë ˆì´í„° ì…ë ¥ (v20)
        const iPurpose = document.getElementById('i_purpose');
        const iActivity = document.getElementById('i_activity');
        const iPartner = document.getElementById('i_partner');
        
        // ê²°ê³¼ ì¶œë ¥ (v20)
        const oModelVersion = document.getElementById('o_model_version');
        const oProbability = document.getElementById('o_probability');
        const oPersona = document.getElementById('o_persona');
        const oHistoryAccordion = document.getElementById('history-accordion');
        const oHistoryOutput = document.getElementById('o_history_output');
        const oRecommendations = document.getElementById('o_recommendations');

        // ìŠ¬ë¼ì´ë” ê°’ í‘œì‹œ
        const updateSliderDisplay = (slider, display) => {
            const suffix = slider.id.includes('income') ? ' ë§Œì›' : (slider.id.includes('age') ? ' ì„¸' : ' ì ');
            display.textContent = slider.value + suffix;
        };
        const ageDisplay = document.getElementById('age-display');
        const incomeDisplay = document.getElementById('income-display');
        const infraDisplay = document.getElementById('infra-display');
        const timeDisplay = document.getElementById('time-display');
        
        iAge.addEventListener('input', () => updateSliderDisplay(iAge, ageDisplay));
        iIncome.addEventListener('input', () => updateSliderDisplay(iIncome, incomeDisplay));
        iInfraSat.addEventListener('input', () => updateSliderDisplay(iInfraSat, infraDisplay));
        iTimeSat.addEventListener('input', () => updateSliderDisplay(iTimeSat, timeDisplay));
        // ì´ˆê¸°ê°’ ì„¤ì •
        updateSliderDisplay(iAge, ageDisplay);
        updateSliderDisplay(iIncome, incomeDisplay);
        updateSliderDisplay(iInfraSat, infraDisplay);
        updateSliderDisplay(iTimeSat, timeDisplay);

        // --- 4. ìƒíƒœ ë³€ìˆ˜ ---
        let currentUserId = ""; // ì˜ˆ: "í™ê¸¸ë™_19900101"
        let currentUserFile = ""; // ì˜ˆ: "users/í™ê¸¸ë™_19900101" (Firestore ê²½ë¡œ)
        let phoneLookupRef = null; // Firestore ì „í™”ë²ˆí˜¸ë¶€ ê²½ë¡œ
        
        // --- 5. í•µì‹¬ ë¡œì§: í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
        function showPage(pageToShow) {
            [pageLogin, pageFixedInfo, pageSimulator, pageResults, loadingEl].forEach(page => {
                page.style.display = 'none'; // hidden í´ë˜ìŠ¤ ëŒ€ì‹  display none ì‚¬ìš©
            });
            pageToShow.style.display = 'block';
        }

        // --- 6. í•µì‹¬ ë¡œì§: ë¡œê·¸ì¸ (ID/ê¶¤ì ) ---
        
        // [ìš”ì²­ 1] ë¡œê·¸ì¸ ë²„íŠ¼ í™œì„±í™” ê²€ì‚¬
        function checkLoginInputs() {
            const name = iName.value.trim();
            const dob = iDob.value.trim();
            const phone = iPhone.value.trim();
            if (name && dob && phone && dob.length === 8 && phone.length > 11) {
                loginBtn.disabled = false;
                oIdStatus.textContent = "âœ… 'ë¡œê·¸ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            } else {
                loginBtn.disabled = true;
                oIdStatus.textContent = "*(ì´ë¦„, ìƒë…„ì›”ì¼(8ìë¦¬), íœ´ëŒ€ì „í™”(11ìë¦¬ ì´ìƒ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”)*";
            }
        }
        [iName, iDob, iPhone].forEach(el => el.addEventListener('input', checkLoginInputs));
        iPhoneChanged.addEventListener('change', () => {
            iOldPhoneContainer.style.display = iPhoneChanged.checked ? 'block' : 'none';
        });

        // [ìš”ì²­ 1] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ
        loginBtn.addEventListener('click', async () => {
            const name = iName.value.trim();
            const dob = iDob.value.trim();
            const phone = iPhone.value.trim();
            const phoneChanged = iPhoneChanged.checked;
            const oldPhone = iOldPhone.value.trim();

            if (phoneChanged && !oldPhone) {
                oIdStatus.textContent = "âš ï¸ ì „í™”ë²ˆí˜¸ ë³€ê²½ ì‹œ, 'ì´ì „ íœ´ëŒ€ì „í™” ë²ˆí˜¸'ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                return;
            }

            currentUserId = `${name}_${dob}`;
            currentUserFile = `users/${currentUserId}`; // Firestore ìœ ì € ê¶¤ì  ê²½ë¡œ
            
            showPage(loadingEl);
            oIdStatus.textContent = "ë¡œê·¸ì¸ ì¤‘...";

            try {
                // (ì´ì „ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ìµëª… ë¡œê·¸ì¸ì„ ë¨¼ì € ìˆ˜í–‰)
                await signInAnonymously(auth); 
                
                const userDocRef = doc(db, currentUserFile);
                const userDoc = await getDoc(userDocRef);

                // ì „í™”ë²ˆí˜¸ ë³€ê²½ ë¡œì§ (v20 ê°œì„ )
                // 1. í˜„ì¬ ì „í™”ë²ˆí˜¸(ë˜ëŠ” ì´ì „ ì „í™”ë²ˆí˜¸)ë¡œ 'ì „í™”ë²ˆí˜¸ë¶€' ì¡°íšŒ
                const phoneToQuery = phoneChanged ? oldPhone : phone;
                const phoneNormalized = phoneToQuery.replace(/-/g, '');
                const phoneQuery = query(collection(db, "phone_lookup"), where("phone", "==", phoneNormalized));
                const phoneQuerySnapshot = await getDocs(phoneQuery);

                let statusMessage = "";
                let historyText = "";

                if (phoneQuerySnapshot.empty) {
                    // ì‹ ê·œ ì‚¬ìš©ì ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¶€ ë“±ë¡ ì•ˆ ëœ ê¸°ì¡´ ì‚¬ìš©ì
                    if (userDoc.exists()) {
                        statusMessage = `âœ… **${name}**ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ì €ì¥ëœ ê¶¤ì ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (ì „í™”ë²ˆí˜¸ë¶€ ë“±ë¡)`;
                        historyText = loadUserHistoryText(userDoc.data());
                    } else {
                        statusMessage = `âœ… **${name}**ë‹˜, ì‹ ê·œ ì‚¬ìš©ìì…ë‹ˆë‹¤. ê¶¤ì  ì €ì¥ì„ ì‹œì‘í•©ë‹ˆë‹¤.`;
                        historyText = "ì‹ ê·œ ì‚¬ìš©ìì…ë‹ˆë‹¤. ì €ì¥ëœ ê¶¤ì ì´ ì—†ìŠµë‹ˆë‹¤.";
                    }
                    // ìƒˆ ì „í™”ë²ˆí˜¸ë¶€ í•­ëª© ìƒì„±
                    const newPhoneRef = doc(db, "phone_lookup", phoneNormalized);
                    await setDoc(newPhoneRef, { userId: currentUserId, phone: phoneNormalized });
                    phoneLookupRef = newPhoneRef; // í˜„ì¬ ì „í™”ë²ˆí˜¸ë¶€ ì°¸ì¡° ì €ì¥

                } else {
                    // ì „í™”ë²ˆí˜¸ë¶€ì— ë“±ë¡ëœ ì‚¬ìš©ì
                    const foundPhoneDoc = phoneQuerySnapshot.docs[0];
                    const foundUserId = foundPhoneDoc.data().userId;

                    if (foundUserId === currentUserId) {
                        // ì •ìƒ ë¡œê·¸ì¸
                        statusMessage = `âœ… **${name}**ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ì €ì¥ëœ ê¶¤ì ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.`;
                        historyText = loadUserHistoryText(userDoc.exists() ? userDoc.data() : null);
                        phoneLookupRef = foundPhoneDoc.ref;
                        
                        if (phoneChanged) {
                            // ì „í™”ë²ˆí˜¸ ë³€ê²½ ì²˜ë¦¬: ì´ì „ ë²ˆí˜¸ ì‚­ì œ, ìƒˆ ë²ˆí˜¸ ë“±ë¡
                            const batch = writeBatch(db);
                            batch.delete(foundPhoneDoc.ref); // ì´ì „ ë²ˆí˜¸ ì‚­ì œ
                            const newPhoneRef = doc(db, "phone_lookup", phone.replace(/-/g, ''));
                            batch.set(newPhoneRef, { userId: currentUserId, phone: phone.replace(/-/g, '') });
                            await batch.commit();
                            phoneLookupRef = newPhoneRef; // ì°¸ì¡°ë¥¼ ìƒˆë¡œ ì—…ë°ì´íŠ¸
                            statusMessage += "\n(ìƒˆ ì „í™”ë²ˆí˜¸ë¡œ ê¶¤ì ì„ ì´ì „í–ˆìŠµë‹ˆë‹¤.)";
                        }
                    } else {
                        // ì´ë¦„/ìƒë…„ì›”ì¼ì´ ì „í™”ë²ˆí˜¸ì™€ ë¶ˆì¼ì¹˜
                        statusMessage = `ğŸš¨ **ì˜¤ë¥˜:** ì „í™”ë²ˆí˜¸(${phoneToQuery})ê°€ ë‹¤ë¥¸ ì‚¬ìš©ì(${foundUserId})ì—ê²Œ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
                        showPage(pageLogin);
                        oIdStatus.textContent = statusMessage;
                        return;
                    }
                }
                
                oIdStatus.textContent = statusMessage;
                oHistoryOutput.innerHTML = historyText;
                oHistoryAccordion.style.display = userDoc.exists() ? 'block' : 'none';
                
                showPage(pageFixedInfo); // 2ë‹¨ê³„ë¡œ ì´ë™

            } catch (error) {
                console.error("Firebase ë¡œê·¸ì¸/ì¡°íšŒ ì˜¤ë¥˜:", error);
                oIdStatus.textContent = `ğŸš¨ Firebase ì˜¤ë¥˜: ${error.message}`;
                showPage(pageLogin);
            }
        });
        
        // 1ë²ˆ ìš”ì²­: ì‚¬ìš©ì ê¶¤ì  ë¡œë“œ (HTMLë¡œ ë³€í™˜)
        function loadUserHistoryText(userData) {
            const history = userData?.history || [];
            if (!history.length) {
                return "ì‹ ê·œ ì‚¬ìš©ìì…ë‹ˆë‹¤. ì €ì¥ëœ ê¶¤ì ì´ ì—†ìŠµë‹ˆë‹¤.";
            }
            let historyText = "";
            history.slice(-3).reverse().forEach(record => {
                const timestamp = record.timestamp.toDate ? record.timestamp.toDate().toLocaleString('ko-KR') : (record.timestamp || 'ì‹œê°„ ëª¨ë¦„');
                const prob = record.probability || 'N/A';
                const persona = record.persona || 'N/A';
                const top1 = (record.top_trajectories && record.top_trajectories[0]) ? record.top_trajectories[0] : {};
                
                historyText += `<hr class="my-2">
                                <p><strong>${timestamp}</strong></p>
                                <ul class="list-disc list-inside text-sm">
                                    <li><strong>ë‹¹ì‹œ í™•ë¥ :</strong> ${prob} | <strong>ì§„ë‹¨:</strong> ${persona}</li>
                                    <li><strong>ë‹¹ì‹œ 1ìˆœìœ„ ì¶”ì²œ:</strong> ${top1.prob || 'N/A'}% (ëª©ì : ${top1.p_name || 'N/A'}, í™œë™: ${top1.a_name || 'N/A'})</li>
                                </ul>`;
            });
            return historyText;
        }

        // --- 7. í•µì‹¬ ë¡œì§: AI ì˜ˆì¸¡ (ê¶¤ì  ì‹œë®¬ë ˆì´í„°) ---
        submitBtn.addEventListener('click', async () => {
            
            // 1. 11ê°œ ì…ë ¥ê°’ ìˆ˜ì§‘
            const inputs = {
                'age': parseInt(iAge.value),
                'job': iJob.value,
                'gender': iGender.value,
                'marriage': iMarriage.value,
                'income': parseInt(iIncome.value),
                'infra_sat': parseInt(iInfraSat.value),
                'time_sat': parseInt(iTimeSat.value),
                'purpose': iPurpose.value,
                'activity': iActivity.value,
                'partner': iPartner.value
            };
            
            // 2. ë¡œë”© í™”ë©´ í‘œì‹œ
            showPage(loadingEl);
            
            try {
                // 3. 'AI ì£¼ë°©'(Render ì„œë²„)ì— ì£¼ë¬¸ì„œ(JSON)ë¥¼ ë³´ëƒ„
                const response = await fetch(AI_SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                
                const data = await response.json();

                // 4. 'AI ì…°í”„'ê°€ ë‹µì¥(data)ì„ ì£¼ë©´, ì˜ˆì˜ê²Œ í‘œì‹œ
                if (data.success) {
                    oModelVersion.textContent = `(AI Model: ${data.model_version})`;
                    oProbability.textContent = data.probability_5star_percent + '%';
                    oPersona.textContent = data.persona;
                    // (Markdownì„ HTMLë¡œ ë³€í™˜)
                    oRecommendations.innerHTML = data.recommendations
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/ğŸ¥‡/g, 'ğŸ†');
                    
                    // 5. [1ë²ˆ ìš”ì²­] Firebaseì— ì´ ê²°ê³¼(ê¶¤ì )ë¥¼ ëˆ„ì  ì €ì¥
                    const userDocRef = doc(db, currentUserFile);
                    const docSnap = await getDoc(userDocRef);
                    const existingData = docSnap.data();
                    
                    const history_data_to_save = {
                        timestamp: serverTimestamp(),
                        model_version: data.model_version,
                        inputs: inputs, // ì‚¬ìš©ìê°€ ì…ë ¥í•œ 11ê°œ ê°’
                        probability: data.probability_5star_percent + '%',
                        persona: data.persona,
                        top_trajectories: data.top_trajectories || [] // (v15 ì„œë²„ê°€ top_trajectoriesë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •)
                    };
                    
                    const newHistory = existingData?.history ? [...existingData.history, history_data_to_save] : [history_data_to_save];

                    await setDoc(userDocRef, {
                        userId: currentUserId,
                        createdAt: existingData?.createdAt || serverTimestamp(),
                        history: newHistory
                    }, { merge: true }); // merge: trueë¡œ ë®ì–´ì“°ì§€ ì•Šê³  ë³‘í•©
                    
                    // [1ë²ˆ ìš”ì²­] ê¶¤ì  ì €ì¥ í›„, 'ê³¼ê±° ê¶¤ì ' UIë„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    oHistoryOutput.innerHTML = loadUserHistoryText({ history: newHistory });
                    oHistoryAccordion.style.display = 'block';

                    // 6. ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì „í™˜
                    showPage(pageResults);
                    
                } else {
                    throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
                }

            } catch (error) {
                // 7. ì—ëŸ¬ê°€ ë‚˜ë©´ ì•Œë ¤ì¤Œ
                console.error("AI ì„œë²„ í†µì‹  ì˜¤ë¥˜:", error);
                showPage(pageSimulator); // 3ë‹¨ê³„ í™”ë©´ìœ¼ë¡œ ë³µê·€
                alert(`AI ì„œë²„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}\n\n'AI ì„œë²„ ì£¼ì†Œ(AI_SERVER_URL)'ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.`);
            }
        });

        // --- 8. í™”ë©´ ì „í™˜ ë²„íŠ¼ë“¤ ---
        
        // 2 -> 3 (ë‹¤ìŒ)
        nextBtn2.addEventListener('click', () => showPage(pageSimulator));
        // 2 -> 1 (ì´ì „/ë¡œê·¸ì•„ì›ƒ)
        prevBtn2.addEventListener('click', () => {
            currentUserId = ""; currentUserFile = ""; phoneLookupRef = null;
            showPage(pageLogin);
            // í¼ ì´ˆê¸°í™”
            iName.value = ""; iDob.value = ""; iPhone.value = "";
            loginBtn.disabled = true;
            oIdStatus.textContent = "*(ì´ë¦„, ìƒë…„ì›”ì¼(8ìë¦¬), íœ´ëŒ€ì „í™”(11ìë¦¬ ì´ìƒ)ë¥¼ ì…ë ¥í•˜ì„¸ìš”)*";
        });
        // 3 -> 2 (ì´ì „)
        prevBtn3.addEventListener('click', () => showPage(pageFixedInfo));
        // 4 -> 3 (ë‹¤ì‹œ ì‹œë®¬ë ˆì´ì…˜)
        restartBtn4.addEventListener('click', () => showPage(pageSimulator));

        // --- 9. ì•± ì‹œì‘ ---
        showPage(pageLogin); // ì²« í™”ë©´ì€ ë¡œê·¸ì¸
        
    </script>
</body>
</html>